"use strict";function parseSecuritySchemes(e){var t={};return _.each(e,function(e){_.each(e,function(e,r){if(assert(e.type),"OAuth 1.0"!==e.type){var s={"OAuth 2.0":"oauth2","Basic Authentication":"basic"}[e.type];assert(s);var a={type:s,description:e.description};if("oauth2"!==s)return void(t[r]=a);var i=e.settings;_.assign(a,{authorizationUrl:i.authorizationUri,tokenUrl:i.accessTokenUri,scopes:_.transform(i.scopes,function(e,t){e[t]=""},{})});var n=i.authorizationGrants;_.each(n,function(e){var s=_.clone(a),i=s.flow={code:"accessCode",token:"implicit",owner:"password",credentials:"application"}[e];("password"===i||"application"===i)&&delete s.authorizationUrl,"implicit"===i&&delete s.tokenUrl;var o=r;_.size(n)>1&&(o=r+"_"+s.flow),t[o]=s})}})}),t}function parseSchemas(e){return _.reduce(e,function(e,t){return _.assign(e,t,function(e,t){return convertSchema(t)})},{})}function parseProtocols(e){return _.map(e,function(e){return e.toLowerCase()})}function parseResources(e,t){var r={};return _.each(e,function(e){assert(!("baseUriParameters"in e));var s=e.relativeUri;assert(s);var a=(t||[]).concat(parseParametersList(e.uriParameters,"path")),i=parseMethodList(e.methods,a);_.isEmpty(i)||(r[s]=i);var n=parseResources(e.resources,a);_.each(n,function(e,t){r[s+t]=e})}),r}function parseMethodList(e,t){var r={};return _.each(e,function(e){var s=parseMethod(e);_.isEmpty(t)||(s.parameters=t.concat(s.parameters)),r[e.method]=s}),r}function parseMethod(e){var t={description:e.description},r=parseParametersList(e.queryParameters,"query");return r=r.concat(parseParametersList(e.headers,"header")),_.isEmpty(r)||(t.parameters=r),parseBody(e.body,t),parseResponses(e,t),t}function parseResponses(e,t){var r=e.responses;return _.isEmpty(r)?{200:{description:HttpStatus(200)}}:(t.responses={},void _.each(r,function(e,r){var s=HttpStatus(parseInt(r)),a=t.responses[r]={description:_.get(e,"description")||s};if(_.has(e,"body")){var i="application/json",n=_.without(_.keys(e.body),i);_.isEmpty(n)||(t.produces=n);var o=_.get(e.body,i);_.isUndefined(o)||(a.schema=convertSchema(_.get(o,"schema")))}}))}function parseParametersList(e,t){return assert(_.isUndefined(e)||_.isPlainObject(e)),_.map(e,function(e,r){assert(_.has(e,"type")&&-1!==["date","string","number","integer","boolean"].indexOf(e.type));var s={type:e.type,"enum":e["enum"],"default":e["default"],maximum:e.maximum,minimum:e.minimum,maxLength:e.maxLength,minLength:e.minLength,pattern:e.pattern};return"date"===s.type&&(s.type="string",s.format="date"),e.repeat===!0&&(assert(-1!==["query","formData"].indexOf(t)),s={type:"array",items:s,collectionFormat:"multi"}),_.assign(s,{name:r,"in":t,description:e.description,required:e.required}),s})}function parseBody(e,t){if(e){var r=_.keys(e);assert(!_.has(r,"application/x-www-form-urlencoded")),assert(!_.has(r,"multipart/form-data"));var s="application/json",a=_.without(r,s);_.isEmpty(a)||(t.consumes=a),-1!==_.indexOf(r,s)&&(_.isUndefined(t.parameters)&&(t.parameters=[]),t.parameters.push({name:"body","in":"body",required:!0,schema:convertSchema(_.get(e[s],"schema"))}))}}function convertSchema(e){if(!_.isUndefined(e)){assert(_.isString(e));try{var e=JSON.parse(e)}catch(t){return void 0}return delete e.id,delete e.$schema,delete e[""],e=jsonCompat.v4(e),jp.apply(e,'$..*["$ref"]',function(e){return"#/definitions/"+e}),"array"!==e.type||_.isUndefined(e.list)||(assert(_.isUndefined(e.items)),assert(1===_.size(e.list)),assert(_.isPlainObject(e.list[0])),e.items=e.list[0],delete e.list),_.each(jp.nodes(e,'$..*[""]'),function(t){var r=t.value,s=t.path;if(_.isArray(r)&&1===_.size(r)&&_.isPlainObject(r[0])){s=_.dropRight(s);var a=jp.value(e,jp.stringify(s));switch(delete a[""],_.isEmpty(a)&&-1!==["properties","items"].indexOf(_.last(s))&&(a=jp.value(e,jp.stringify(_.dropRight(s))),delete a.properties),a.type){case"object":a.additionalProperties=r[0];break;case"array":a.items=r[0];break;default:assert(!1)}}}),jp.apply(e,'$..properties[?(@.length === 1 && @[0].type === "array")]',function(e){return e[0]}),_.each(jp.nodes(e,"$..properties[?(@.length === 1)]"),function(t){var r=_.last(t.path),s=jp.value(e,jp.stringify(_.dropRight(t.path)));"array"===s.type&&(s[r]={type:"array",items:t.value[0]},delete s.type)}),jp.apply(e,'$..*[?(@.type === "array" && @.items.length === 0)]',function(e){e.items={}}),e}}var assert=require("assert"),URI=require("urijs"),_=require("lodash"),jsonCompat=require("json-schema-compatibility"),HttpStatus=require("http-status-codes").getStatusText,jp=require("jsonpath");exports.convert=function(e){var t=_.assign({swagger:"2.0",info:{title:e.title,version:e.version},securityDefinitions:parseSecuritySchemes(e.securitySchemes),paths:parseResources(e.resources)});return t};